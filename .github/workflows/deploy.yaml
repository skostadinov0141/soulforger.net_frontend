name: Deploy Stable Frontend
on: workflow_dispatch
#  release:
#    types: [published]

jobs:
  prepare:
    name: Prepare
    runs-on: self-hosted
    steps:
      - name: Create Source Directory
        run: mkdir -p /home/soulforger/source
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend
  build:
    name: Build
    runs-on: self-hosted
    needs: prepare
    steps:
      - name: Create Docker Image
        run: sudo docker build -t soulforger/frontend:latest /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend
        #run: sudo docker build -t soulforger/frontend:${{ github.ref_name }} /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend
  stop-old-container:
    name: Stop Old Container
    runs-on: self-hosted
    needs: build
    steps:
      - name: Stop Old Container
        run: sudo docker stop soulforger-frontend || true
      - name: Remove Old Container
        run: sudo docker rm soulforger-frontend || true
  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: stop-old-container
    steps:
      - name: Start New Container
        run: sudo docker run -d -p 80:80 --name soulforger-frontend soulforger/frontend:latest
        #run: sudo docker run -d -p 80:80 --name soulforger-frontend soulforger/frontend:${{ github.ref_name }}
