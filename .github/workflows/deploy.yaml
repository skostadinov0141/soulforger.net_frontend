name: Deploy Frontend
on:
  release:
    types: [published]
env:
  VERSION: ${{ github.ref_name }}
  CODE_PATH: /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend
jobs:
  prepare:
    name: Prepare
    runs-on: self-hosted
    steps:
      - name: Set FINAL_PATH based on tag
        run: |
          if [[ "${{ github.ref_name }}" == *beta* ]]; then
            echo "FINAL_PATH=/home/soulforger/frontend-deployments/beta/${{ github.ref_name }}" >> $GITHUB_ENV
            echo $FINAL_PATH
          elif [[ "${{ github.ref_name }}" == *stable* ]]; then
            echo "FINAL_PATH=/home/soulforger/frontend-deployments/stable/${{ github.ref_name }}" >> $GITHUB_ENV
            echo $FINAL_PATH
          else
            echo "FINAL_PATH=/home/soulforger/frontend-deployments/undefined/${{ github.ref_name }}" >> $GITHUB_ENV
            echo $FINAL_PATH
          fi
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODE_PATH }}
      - name: Create nginx Directory
        run: mkdir -p /home/soulforger/frontend-deployments/nginx/conf
      - name: Create Certbot WWW Directory
        run: mkdir -p /home/soulforger/frontend-deployments/certbot/www
      - name: Create Certbot Conf Directory
        run: mkdir -p /home/soulforger/frontend-deployments/certbot/conf
      - name: Copy Nginx Config
        run: cp $CODE_PATH/soulforger.conf /home/soulforger/frontend-deployments/nginx/conf/soulforger.conf
      - name: Copy code to final path
        run: cp -r $CODE_PATH $FINAL_PATH
  build:
    name: Build
    runs-on: self-hosted
    needs: prepare
    steps:
      - name: Remove old containers
        run: docker compose -p soulforger-frontend down
      - name: Docker Compose Up
        run: docker compose -p soulforger-frontend -f $FINAL_PATH/docker-compose.yaml up -d
  secure:
    name: Secure and Deploy
    runs-on: self-hosted
    needs: build
    steps:
      - name: Restart Nginx
        run: docker compose -p soulforger-frontend restart