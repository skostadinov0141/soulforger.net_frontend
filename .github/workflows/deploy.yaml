name: Deploy Stable Frontend
on: workflow_dispatch
#  release:
#    types: [published]

jobs:
  prepare:
    name: Prepare
    runs-on: self-hosted
    steps:
      - name: Create Source Directory
        run: mkdir -p /home/soulforger/source
      - name: Create nginx Directory
        run: mkdir -p /home/soulforger/nginx/conf
      - name: Create Certbot Directory
        run: mkdir -p /home/soulforger/certbot/www
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend
  build:
    name: Build
    runs-on: self-hosted
    needs: prepare
    steps:
      - name: Docker Compose Up
        run: sudo docker compose -p soulforger/frontend up /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend
        #run: sudo docker build -t soulforger/frontend:${{ github.ref_name }} /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend
#  stop-old-container:
#    name: Stop Old Container
#    runs-on: self-hosted
#    needs: build
#    steps:
#      - name: Stop Old Container
#        run: sudo docker stop soulforger-frontend || true
#      - name: Remove Old Container
#        run: sudo docker rm soulforger-frontend || true
  secure:
    name: Secure and Deploy
    runs-on: self-hosted
    needs: build
    steps:
      - name: Create certs
        run: sudo docker compose run --rm certbot certonly -m soulforger.net@gmail.com --webroot --webroot-path /var/www/certbot/ -d soulforger.net
        #run: sudo docker run -d -p 80:80 --name soulforger-frontend soulforger/frontend:${{ github.ref_name }}
