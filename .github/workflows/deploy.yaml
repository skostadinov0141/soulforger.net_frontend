name: Deploy Stable Frontend
on: workflow_dispatch
#  release:
#    types: [published]

jobs:
  prepare:
    name: Prepare
    runs-on: self-hosted
    steps:
      - name: Create Source Directory
        run: mkdir -p /home/soulforger/source
      - name: Create nginx Directory
        run: mkdir -p /home/soulforger/nginx/conf
      - name: Create Certbot Directory
        run: mkdir -p /home/soulforger/certbot/www
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend
      - name: Copy Nginx Config
        run: cp /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend/soulforger.conf /home/soulforger/nginx/conf/soulforger.conf
  build:
    name: Build
    runs-on: self-hosted
    needs: prepare
    steps:
      - name: Stop old containers
        run: docker compose -p soulforger-frontend -f /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend/docker-compose.yaml down
      - name: Delete old containers
        run: docker compose -p soulforger-frontend -f /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend/docker-compose.yaml rm
      - name: Docker Compose Up
        run: docker compose -p soulforger-frontend -f /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend/docker-compose.yaml up -d
  secure:
    name: Secure and Deploy
    runs-on: self-hosted
    needs: build
    steps:
      - name: Create or renew certs
        run: if [ ! -d /home/soulforger/certbot/conf/live/soulforger.net ]; then docker compose run certbot certonly -m soulforger.net@gmail.com --agree-tos --webroot --webroot-path /var/www/certbot/ -d soulforger.net; fi
      - name: Restart Nginx
        run: docker compose -f /home/soulforger/actions-runner/_work/soulforger.net_frontend/soulforger.net_frontend/docker-compose.yaml restart
        #run:  docker run -d -p 80:80 --name soulforger-frontend soulforger/frontend:${{ github.ref_name }}
